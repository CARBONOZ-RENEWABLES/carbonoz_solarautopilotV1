<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Pricing - Solar Autopilot</title>
    <link rel="stylesheet" href="<%= ingress_path %>/css/dynamic-pricing.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    
    <style>
        /* Dynamic Pricing Professional Styles */

:root {
  /* Color Palette */
  --primary-color: #DEAF0B;
  --primary-light: #60a5fa;
  --primary-dark: #1d4ed8;
  --secondary-color: #64748b;
  --success-color: #10b981;
  --warning-color: #f59e0b;
  --error-color: #ef4444;
  --info-color: #06b6d4;
  
  /* Background Colors */
  --bg-primary: #f8fafc;
  --bg-secondary: #ffffff;
  --bg-tertiary: #DEAF0B;
  --bg-dark: #1e293b;
  --bg-card: #ffffff;
  
  /* Text Colors */
  --text-primary: #1e293b;
  --text-secondary: #64748b;
  --text-muted: #94a3b8;
  --text-light: #cbd5e1;
  --text-white: #ffffff;
  
  /* Border Colors */
  --border-color: #e2e8f0;
  --border-light: #f1f5f9;
  --border-dark: #cbd5e1;
  
  /* Weather Colors */
  --weather-sunny: #fbbf24;
  --weather-cloudy: #6b7280;
  --weather-rainy: #3b82f6;
  --weather-stormy: #6366f1;
  --weather-snowy: #e5e7eb;
  
  /* Price Level Colors */
  --price-very-cheap: #10b981;
  --price-cheap: #22c55e;
  --price-normal: #64748b;
  --price-expensive: #f59e0b;
  --price-very-expensive: #ef4444;
  
  /* Spacing */
  --spacing-xs: 0.25rem;
  --spacing-sm: 0.5rem;
  --spacing-md: 1rem;
  --spacing-lg: 1.5rem;
  --spacing-xl: 2rem;
  --spacing-2xl: 3rem;
  
  /* Border Radius */
  --radius-sm: 0.375rem;
  --radius-md: 0.5rem;
  --radius-lg: 0.75rem;
  --radius-xl: 1rem;
  
  /* Shadows */
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  
  /* Transitions */
  --transition-fast: 150ms ease-in-out;
  --transition-normal: 300ms ease-in-out;
  --transition-slow: 500ms ease-in-out;
}

/* Reset and Base Styles */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}


/* Container */
.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: var(--spacing-md);
  min-height: 100vh;
}

/* Header */
.header {
  background: #DEAF0B;
  color: var(--text-white);
  padding: var(--spacing-lg) var(--spacing-xl);
  border-radius: var(--radius-lg);
  margin-bottom: var(--spacing-xl);
  box-shadow: var(--shadow-lg);
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: var(--spacing-md);
}

.header-left h1 {
  font-size: 2rem;
  font-weight: 700;
  margin-bottom: var(--spacing-xs);
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

.header-left .subtitle {
  font-size: 1rem;
  opacity: 0.9;
  font-weight: 400;
}

.header-right {
  display: flex;
  gap: var(--spacing-lg);
  align-items: center;
}

.status-indicator, .learner-mode-indicator {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  padding: var(--spacing-xs) var(--spacing-sm);
  background: rgba(255, 255, 255, 0.2);
  border-radius: var(--radius-md);
  font-size: 0.875rem;
  backdrop-filter: blur(10px);
}

.status-indicator.connected .fa-circle {
  color: var(--success-color);
}

.status-indicator.disconnected .fa-circle {
  color: var(--error-color);
}

.status-indicator.connecting .fa-circle {
  color: var(--warning-color);
  animation: pulse 2s infinite;
}

.learner-mode-indicator.active {
  background: rgba(16, 185, 129, 0.2);
}

.learner-mode-indicator.inactive {
  background: rgba(239, 68, 68, 0.2);
}

/* Quick Actions */
.quick-actions {
  display: flex;
  gap: var(--spacing-md);
  margin-bottom: var(--spacing-xl);
  flex-wrap: wrap;
}

.quick-btn {
  flex: 1;
  min-width: 150px;
  padding: var(--spacing-md) var(--spacing-lg);
  border: none;
  border-radius: var(--radius-md);
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition-fast);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-xs);
  box-shadow: var(--shadow-sm);
}

.quick-btn[data-action="charge"] {
  background: linear-gradient(135deg, var(--success-color), #22c55e);
  color: white;
}

.quick-btn[data-action="stop"] {
  background: linear-gradient(135deg, var(--error-color), #f87171);
  color: white;
}

.quick-btn:not([data-action]) {
  background: var(--bg-secondary);
  color: var(--text-primary);
  border: 1px solid var(--border-color);
}

.quick-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.quick-btn:active {
  transform: translateY(0);
}

.quick-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

/* Dashboard Grid */
.dashboard-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--spacing-xl);
  margin-bottom: var(--spacing-xl);
}

@media (max-width: 1024px) {
  .dashboard-grid {
    grid-template-columns: 1fr;
  }
}

/* Panel Styles */
.panel {
  background: var(--bg-card);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-md);
  overflow: hidden;
  border: 1px solid var(--border-light);
}

.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--spacing-lg);
  border-bottom: 1px solid var(--border-light);
  background: var(--bg-tertiary);
}

.panel-header h3 {
  font-size: 1.125rem;
  font-weight: 600;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

.panel-controls {
  display: flex;
  gap: var(--spacing-sm);
  align-items: center;
}

.panel-content {
  padding: var(--spacing-lg);
}

/* Status Panel */
.status-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: var(--spacing-lg);
  margin-bottom: var(--spacing-xl);
}

.status-card {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
  padding: var(--spacing-lg);
  background: var(--bg-tertiary);
  border-radius: var(--radius-md);
  transition: all var(--transition-fast);
}

.status-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.status-icon {
  width: 48px;
  height: 48px;
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  color: white;
}

.status-icon.battery {
  background: linear-gradient(135deg, var(--success-color), #22c55e);
}

.status-icon.price {
  background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
}

.status-icon.pv {
  background: linear-gradient(135deg, var(--weather-sunny), #fcd34d);
}

.status-icon.load {
  background: linear-gradient(135deg, var(--secondary-color), #94a3b8);
}

.status-icon.grid {
  background: linear-gradient(135deg, var(--info-color), #67e8f9);
}

.status-info h4 {
  font-size: 0.875rem;
  color: var(--text-secondary);
  font-weight: 500;
  margin-bottom: var(--spacing-xs);
}

.status-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text-primary);
}

.status-unit {
  font-size: 0.875rem;
  color: var(--text-muted);
  margin-left: var(--spacing-xs);
}

/* Weather Card */
.weather-card {
  grid-column: span 2;
}

.weather-icon {
  width: 48px;
  height: 48px;
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  color: white;
  position: relative;
}

.weather-icon.sunny {
  background: linear-gradient(135deg, var(--weather-sunny), #fcd34d);
}

.weather-icon.cloudy {
  background: linear-gradient(135deg, var(--weather-cloudy), #9ca3af);
}

.weather-icon.rainy {
  background: linear-gradient(135deg, var(--weather-rainy), #60a5fa);
}

.weather-icon.stormy {
  background: linear-gradient(135deg, var(--weather-stormy), #8b5cf6);
}

.weather-icon.snowy {
  background: linear-gradient(135deg, var(--weather-snowy), #f3f4f6);
  color: var(--text-secondary);
}

.weather-info {
  flex: 1;
}

.weather-temp {
  font-size: 1.25rem;
  font-weight: 600;
  color: var(--text-primary);
}

.weather-desc {
  font-size: 0.875rem;
  color: var(--text-secondary);
  text-transform: capitalize;
}

.weather-animation {
  position: absolute;
  top: -5px;
  right: -5px;
  width: 15px;
  height: 15px;
}

/* Weather Animations */
@keyframes rainDrop {
  0% { transform: translateY(-10px); opacity: 1; }
  100% { transform: translateY(10px); opacity: 0; }
}

@keyframes snowFlake {
  0% { transform: translateY(-10px) rotate(0deg); opacity: 1; }
  100% { transform: translateY(10px) rotate(360deg); opacity: 0; }
}

@keyframes lightning {
  0%, 90%, 100% { opacity: 0; }
  5%, 85% { opacity: 1; }
}

.weather-animation.rain::before {
  content: 'üíß';
  position: absolute;
  animation: rainDrop 1s infinite;
}

.weather-animation.snow::before {
  content: '‚ùÑÔ∏è';
  position: absolute;
  animation: snowFlake 2s infinite;
}

.weather-animation.storm::before {
  content: '‚ö°';
  position: absolute;
  animation: lightning 2s infinite;
}

/* Price Level Indicator */
.price-level {
  display: inline-block;
  padding: var(--spacing-xs) var(--spacing-sm);
  border-radius: var(--radius-sm);
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  margin-top: var(--spacing-xs);
}

.price-level.very-cheap {
  background: rgba(16, 185, 129, 0.1);
  color: var(--price-very-cheap);
}

.price-level.cheap {
  background: rgba(34, 197, 94, 0.1);
  color: var(--price-cheap);
}

.price-level.normal {
  background: rgba(100, 116, 139, 0.1);
  color: var(--price-normal);
}

.price-level.expensive {
  background: rgba(245, 158, 11, 0.1);
  color: var(--price-expensive);
}

.price-level.very-expensive {
  background: rgba(239, 68, 68, 0.1);
  color: var(--price-very-expensive);
}

/* Charging Decision */
.charging-decision {
  padding: var(--spacing-lg);
  border-radius: var(--radius-md);
  text-align: center;
  font-weight: 600;
}

.charging-decision.should-charge {
  background: rgba(16, 185, 129, 0.1);
  border: 2px solid rgba(16, 185, 129, 0.2);
  color: var(--success-color);
}

.charging-decision.should-not-charge {
  background: rgba(239, 68, 68, 0.1);
  border: 2px solid rgba(239, 68, 68, 0.2);
  color: var(--error-color);
}

.charging-decision.analyzing {
  background: rgba(245, 158, 11, 0.1);
  border: 2px solid rgba(245, 158, 11, 0.2);
  color: var(--warning-color);
}

.decision-status {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-sm);
}

/* Chart Panel */
.chart-container {
  position: relative;
  height: 300px;
  margin-bottom: var(--spacing-lg);
}

.chart-legend {
  display: flex;
  justify-content: center;
  gap: var(--spacing-lg);
  flex-wrap: wrap;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  font-size: 0.875rem;
}

.legend-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
}

.legend-item.very-cheap .legend-dot {
  background: var(--price-very-cheap);
}

.legend-item.cheap .legend-dot {
  background: var(--price-cheap);
}

.legend-item.normal .legend-dot {
  background: var(--price-normal);
}

.legend-item.expensive .legend-dot {
  background: var(--price-expensive);
}

.legend-item.very-expensive .legend-dot {
  background: var(--price-very-expensive);
}

/* Configuration Tabs */
.config-tabs {
  background: var(--bg-card);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-md);
  overflow: hidden;
  border: 1px solid var(--border-light);
  margin-bottom: var(--spacing-xl);
}

.tabs-header {
  display: flex;
  border-bottom: 1px solid var(--border-light);
  background: var(--bg-tertiary);
  overflow-x: auto;
}

.tab-btn {
  flex: 1;
  min-width: 120px;
  padding: var(--spacing-md) var(--spacing-lg);
  border: none;
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all var(--transition-fast);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-xs);
  font-weight: 500;
  border-bottom: 3px solid transparent;
  white-space: nowrap;
}

.tab-btn:hover {
  background: rgba(37, 99, 235, 0.05);
  color: var(--text-primary);
}

.tab-btn.active {
  color: var(--primary-color);
  border-bottom-color: var(--primary-color);
  background: rgba(37, 99, 235, 0.05);
}

.tabs-content {
  padding: var(--spacing-xl);
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

/* Configuration Sections */
.config-section {
  margin-bottom: var(--spacing-xl);
}

.config-section h4 {
  font-size: 1.125rem;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: var(--spacing-lg);
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding-bottom: var(--spacing-sm);
  border-bottom: 2px solid var(--border-light);
}

.config-section h5 {
  font-size: 1rem;
  font-weight: 600;
  color: var(--text-primary);
  margin: var(--spacing-lg) 0 var(--spacing-md) 0;
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

/* Configuration Grid */
.config-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: var(--spacing-lg);
  align-items: start;
}

.config-item {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-sm);
}

.config-item.full-width {
  grid-column: 1 / -1;
}

.config-item label {
  font-weight: 500;
  color: var(--text-primary);
  font-size: 0.875rem;
}

.config-input, .select-input {
  padding: var(--spacing-sm) var(--spacing-md);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  background: var(--bg-secondary);
  color: var(--text-primary);
  transition: all var(--transition-fast);
  font-size: 0.875rem;
}

.config-input:focus, .select-input:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.input-group {
  display: flex;
  gap: 0;
  align-items: stretch;
}

.input-group .config-input {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
  border-right: none;
}

.input-addon {
  padding: var(--spacing-sm) var(--spacing-md);
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-left: none;
  border-top-right-radius: var(--radius-md);
  border-bottom-right-radius: var(--radius-md);
  font-size: 0.875rem;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
}

.help-text {
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-top: var(--spacing-xs);
}

/* Toggle Switches */
.toggle-group {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
}

.toggle-label {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  cursor: pointer;
  font-weight: 500;
}

.toggle-input {
  display: none;
}

.toggle-slider {
  width: 44px;
  height: 24px;
  background: var(--border-dark);
  border-radius: 12px;
  position: relative;
  transition: all var(--transition-fast);
}

.toggle-slider::before {
  content: '';
  position: absolute;
  top: 2px;
  left: 2px;
  width: 20px;
  height: 20px;
  background: white;
  border-radius: 50%;
  transition: all var(--transition-fast);
  box-shadow: var(--shadow-sm);
}

.toggle-input:checked + .toggle-slider {
  background: var(--primary-color);
}

.toggle-input:checked + .toggle-slider::before {
  transform: translateX(20px);
}

.toggle-text {
  color: var(--text-primary);
  font-size: 0.875rem;
}

/* Checkbox Groups */
.checkbox-group {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-sm);
}

.checkbox-label {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  cursor: pointer;
  padding: var(--spacing-xs) 0;
  font-size: 0.875rem;
}

.checkbox-label input[type="checkbox"] {
  display: none;
}

.checkmark {
  width: 18px;
  height: 18px;
  border: 2px solid var(--border-color);
  border-radius: var(--radius-sm);
  position: relative;
  transition: all var(--transition-fast);
}

.checkbox-label input:checked + .checkmark {
  background: var(--primary-color);
  border-color: var(--primary-color);
}

.checkbox-label input:checked + .checkmark::after {
  content: '‚úì';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  font-size: 12px;
  font-weight: bold;
}

.checkbox-label.very-cheap input:checked + .checkmark {
  background: var(--price-very-cheap);
  border-color: var(--price-very-cheap);
}

.checkbox-label.cheap input:checked + .checkmark {
  background: var(--price-cheap);
  border-color: var(--price-cheap);
}

.checkbox-label.normal input:checked + .checkmark {
  background: var(--price-normal);
  border-color: var(--price-normal);
}

/* Status Displays */
.tibber-status {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: var(--spacing-md);
  padding: var(--spacing-lg);
  background: var(--bg-tertiary);
  border-radius: var(--radius-md);
  margin-top: var(--spacing-lg);
}

.status-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--spacing-sm) 0;
}

.status-item .label {
  font-size: 0.875rem;
  color: var(--text-secondary);
  font-weight: 500;
}

.status-item .value {
  font-size: 0.875rem;
  color: var(--text-primary);
  font-weight: 600;
}

/* Weather Display */
.weather-display {
  margin-top: var(--spacing-lg);
}

.weather-current {
  display: flex;
  gap: var(--spacing-lg);
  padding: var(--spacing-lg);
  background: var(--bg-tertiary);
  border-radius: var(--radius-md);
  align-items: center;
}

.weather-main {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
}

.weather-icon-large {
  width: 64px;
  height: 64px;
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2rem;
  color: white;
  background: linear-gradient(135deg, var(--weather-cloudy), #9ca3af);
}

.weather-temp-large {
  font-size: 2rem;
  font-weight: 700;
  color: var(--text-primary);
}

.weather-details {
  flex: 1;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: var(--spacing-sm);
}

.weather-detail {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.weather-detail .label {
  font-size: 0.875rem;
  color: var(--text-secondary);
  font-weight: 500;
}

.weather-detail .value {
  font-size: 0.875rem;
  color: var(--text-primary);
  font-weight: 600;
}

/* Power Rules */
.power-rules {
  margin-top: var(--spacing-lg);
}

.power-rules-list {
  margin-top: var(--spacing-lg);
  display: flex;
  flex-direction: column;
  gap: var(--spacing-md);
}

.power-rule-item {
  padding: var(--spacing-lg);
  background: var(--bg-tertiary);
  border-radius: var(--radius-md);
  border: 1px solid var(--border-light);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.power-rule-info h6 {
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: var(--spacing-xs);
}

.power-rule-info p {
  font-size: 0.875rem;
  color: var(--text-secondary);
  margin-bottom: var(--spacing-xs);
}

.power-rule-priority {
  padding: var(--spacing-xs) var(--spacing-sm);
  border-radius: var(--radius-sm);
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
}

.power-rule-priority.high {
  background: rgba(239, 68, 68, 0.1);
  color: var(--error-color);
}

.power-rule-priority.medium {
  background: rgba(245, 158, 11, 0.1);
  color: var(--warning-color);
}

.power-rule-priority.low {
  background: rgba(100, 116, 139, 0.1);
  color: var(--secondary-color);
}

.power-rule-actions {
  display: flex;
  gap: var(--spacing-sm);
}

/* Schedule Builder */
.schedule-builder {
  margin-top: var(--spacing-lg);
}

.schedules-list {
  margin-top: var(--spacing-lg);
  display: flex;
  flex-direction: column;
  gap: var(--spacing-md);
}

.schedule-item {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
  padding: var(--spacing-md);
  background: var(--bg-tertiary);
  border-radius: var(--radius-md);
  border: 1px solid var(--border-light);
}

.schedule-time {
  font-weight: 600;
  color: var(--text-primary);
  min-width: 120px;
}

.schedule-days {
  flex: 1;
  color: var(--text-secondary);
  font-size: 0.875rem;
}

/* Inverter Status */
.inverter-status {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: var(--spacing-md);
  margin-top: var(--spacing-md);
}

.inverter-item {
  padding: var(--spacing-lg);
  background: var(--bg-tertiary);
  border-radius: var(--radius-md);
  border: 1px solid var(--border-light);
}

.inverter-item h6 {
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: var(--spacing-sm);
}

.inverter-type {
  display: inline-block;
  padding: var(--spacing-xs) var(--spacing-sm);
  border-radius: var(--radius-sm);
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  margin-bottom: var(--spacing-sm);
}

.inverter-type.legacy {
  background: rgba(100, 116, 139, 0.1);
  color: var(--secondary-color);
}

.inverter-type.new {
  background: rgba(37, 99, 235, 0.1);
  color: var(--primary-color);
}

.inverter-type.hybrid {
  background: rgba(16, 185, 129, 0.1);
  color: var(--success-color);
}

.inverter-type.unknown {
  background: rgba(245, 158, 11, 0.1);
  color: var(--warning-color);
}

/* Health Indicators */
.health-indicators {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: var(--spacing-md);
  margin-top: var(--spacing-md);
}

.health-item {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding: var(--spacing-md);
  background: var(--bg-tertiary);
  border-radius: var(--radius-md);
}

.health-icon {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1rem;
  color: white;
}

.health-icon.good {
  background: var(--success-color);
}

.health-icon.warning {
  background: var(--warning-color);
}

.health-icon.error {
  background: var(--error-color);
}

.health-info h6 {
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: var(--spacing-xs);
}

.health-info p {
  font-size: 0.875rem;
  color: var(--text-secondary);
}

/* Buttons */
.btn {
  padding: var(--spacing-sm) var(--spacing-lg);
  border-radius: var(--radius-md);
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition-fast);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-xs);
  font-size: 0.875rem;
  text-decoration: none;
  border: 1px solid transparent;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn-primary {
  background: var(--primary-color);
  color: white;
}

.btn-primary:hover:not(:disabled) {
  background: var(--primary-dark);
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}

.btn-secondary {
  background: var(--secondary-color);
  color: white;
}

.btn-secondary:hover:not(:disabled) {
  background: #475569;
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}

.btn-outline {
  background: transparent;
  color: var(--text-primary);
  border-color: var(--border-color);
}

.btn-outline:hover:not(:disabled) {
  background: var(--bg-tertiary);
  transform: translateY(-1px);
}

.btn-icon {
  padding: var(--spacing-sm);
  width: 36px;
  height: 36px;
  border-radius: var(--radius-md);
  background: transparent;
  color: var(--text-secondary);
  border: 1px solid var(--border-color);
}

.btn-icon:hover:not(:disabled) {
  background: var(--bg-tertiary);
  color: var(--text-primary);
}

/* Actions Footer */
.actions-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: var(--spacing-lg);
  padding: var(--spacing-lg);
  background: var(--bg-card);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-md);
  border: 1px solid var(--border-light);
  flex-wrap: wrap;
}

.actions-left, .actions-right {
  display: flex;
  gap: var(--spacing-md);
  flex-wrap: wrap;
}

/* Modals */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  backdrop-filter: blur(5px);
}

.modal.active {
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-content {
  background: var(--bg-card);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-xl);
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--spacing-lg);
  border-bottom: 1px solid var(--border-light);
}

.modal-header h3 {
  font-size: 1.25rem;
  font-weight: 600;
  color: var(--text-primary);
}

.modal-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  color: var(--text-secondary);
  cursor: pointer;
  padding: var(--spacing-xs);
}

.modal-close:hover {
  color: var(--text-primary);
}

.modal-body {
  padding: var(--spacing-lg);
}

.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: var(--spacing-md);
  padding: var(--spacing-lg);
  border-top: 1px solid var(--border-light);
}

/* Toast Notifications */
.toast-container {
  position: fixed;
  top: var(--spacing-lg);
  right: var(--spacing-lg);
  z-index: 2000;
  display: flex;
  flex-direction: column;
  gap: var(--spacing-sm);
}

.toast {
  padding: var(--spacing-md) var(--spacing-lg);
  border-radius: var(--radius-md);
  color: white;
  font-weight: 500;
  min-width: 250px;
  box-shadow: var(--shadow-lg);
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  transform: translateX(100%);
  transition: transform var(--transition-normal);
}

.toast.show {
  transform: translateX(0);
}

.toast.success {
  background: var(--success-color);
}

.toast.error {
  background: var(--error-color);
}

.toast.warning {
  background: var(--warning-color);
}

.toast.info {
  background: var(--info-color);
}

/* Animations */
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.loading {
  animation: spin 1s linear infinite;
}

.fade-in {
  animation: fadeIn var(--transition-normal);
}

/* Responsive Design */
@media (max-width: 768px) {
  .container {
    padding: var(--spacing-sm);
  }
  
  .header-content {
    flex-direction: column;
    text-align: center;
  }
  
  .header-right {
    justify-content: center;
  }
  
  .quick-actions {
    flex-direction: column;
  }
  
  .quick-btn {
    min-width: auto;
  }
  
  .dashboard-grid {
    grid-template-columns: 1fr;
    gap: var(--spacing-lg);
  }
  
  .status-grid {
    grid-template-columns: 1fr;
  }
  
  .weather-card {
    grid-column: span 1;
  }
  
  .config-grid {
    grid-template-columns: 1fr;
  }
  
  .tabs-header {
    flex-wrap: wrap;
  }
  
  .tab-btn {
    flex: none;
    min-width: 100px;
  }
  
  .tabs-content {
    padding: var(--spacing-md);
  }
  
  .actions-footer {
    flex-direction: column;
  }
  
  .actions-left, .actions-right {
    width: 100%;
    justify-content: center;
  }
  
  .modal-content {
    width: 95%;
    margin: var(--spacing-md);
  }
  
  .weather-current {
    flex-direction: column;
    text-align: center;
  }
  
  .weather-details {
    grid-template-columns: 1fr;
  }
  
  .power-rule-item {
    flex-direction: column;
    align-items: flex-start;
    gap: var(--spacing-md);
  }
  
  .schedule-item {
    flex-direction: column;
    align-items: flex-start;
  }
}

@media (max-width: 480px) {
  .header-left h1 {
    font-size: 1.5rem;
  }
  
  .status-card {
    flex-direction: column;
    text-align: center;
  }
  
  .chart-container {
    height: 250px;
  }
  
  .chart-legend {
    flex-direction: column;
    align-items: center;
    gap: var(--spacing-sm);
  }
  
  .tibber-status {
    grid-template-columns: 1fr;
  }
  
  .toast-container {
    left: var(--spacing-sm);
    right: var(--spacing-sm);
  }
  
  .toast {
    min-width: auto;
  }
}

/* Print Styles */
@media print {
  .quick-actions,
  .actions-footer,
  .modal {
    display: none;
  }
  
  .container {
    max-width: none;
    padding: 0;
  }
  
  .dashboard-grid {
    grid-template-columns: 1fr;
  }
  
  .panel {
    box-shadow: none;
    border: 1px solid var(--border-color);
    page-break-inside: avoid;
    margin-bottom: var(--spacing-lg);
  }
}
    </style>
  
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-left">
                    <h1><i class="fas fa-bolt"></i> Dynamic Pricing Control</h1>
                    <p class="subtitle">Intelligent battery charging with Tibber integration</p>
                </div>
                <div class="header-right">
                    <div class="status-indicator" id="connectionStatus">
                        <i class="fas fa-circle"></i> <span>Connecting...</span>
                    </div>
                    <div class="learner-mode-indicator" id="learnerModeStatus">
                        <i class="fas fa-graduation-cap"></i> <span>Learner Mode</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Quick Actions Bar -->
        <div class="quick-actions">
            <button class="quick-btn" id="manualChargeBtn" data-action="charge">
                <i class="fas fa-play"></i> Start Charging
            </button>
            <button class="quick-btn" id="manualStopBtn" data-action="stop">
                <i class="fas fa-stop"></i> Stop Charging
            </button>
            <button class="quick-btn" id="refreshDataBtn">
                <i class="fas fa-refresh"></i> Refresh Data
            </button>
            <button class="quick-btn" id="testConditionsBtn">
                <i class="fas fa-flask"></i> Test Conditions
            </button>
        </div>

        <!-- Main Dashboard -->
        <div class="dashboard-grid">
            <!-- Current Status Panel -->
            <div class="panel status-panel">
                <div class="panel-header">
                    <h3><i class="fas fa-tachometer-alt"></i> Current Status</h3>
                    <div class="panel-controls">
                        <button class="btn btn-icon" id="refreshStatusBtn">
                            <i class="fas fa-sync"></i>
                        </button>
                    </div>
                </div>
                <div class="panel-content">
                    <div class="status-grid">
                        <!-- Battery Status -->
                        <div class="status-card">
                            <div class="status-icon battery">
                                <i class="fas fa-battery-three-quarters"></i>
                            </div>
                            <div class="status-info">
                                <h4>Battery SoC</h4>
                                <span class="status-value" id="batterySOC">--</span>
                                <span class="status-unit">%</span>
                            </div>
                        </div>

                        <!-- Current Price -->
                        <div class="status-card">
                            <div class="status-icon price">
                                <i class="fas fa-euro-sign"></i>
                            </div>
                            <div class="status-info">
                                <h4>Current Price</h4>
                                <span class="status-value" id="currentPrice">--</span>
                                <span class="status-unit" id="currentCurrency">EUR/kWh</span>
                                <div class="price-level" id="priceLevel"></div>
                            </div>
                        </div>

                        <!-- PV Power -->
                        <div class="status-card">
                            <div class="status-icon pv">
                                <i class="fas fa-sun"></i>
                            </div>
                            <div class="status-info">
                                <h4>PV Power</h4>
                                <span class="status-value" id="pvPower">--</span>
                                <span class="status-unit">W</span>
                            </div>
                        </div>

                        <!-- Load Power -->
                        <div class="status-card">
                            <div class="status-icon load">
                                <i class="fas fa-home"></i>
                            </div>
                            <div class="status-info">
                                <h4>Load</h4>
                                <span class="status-value" id="loadPower">--</span>
                                <span class="status-unit">W</span>
                            </div>
                        </div>

                        <!-- Battery Power -->
                        <div class="status-card">
                            <div class="status-icon battery-power">
                                <i class="fas fa-battery-bolt"></i>
                            </div>
                            <div class="status-info">
                                <h4>Battery Power</h4>
                                <span class="status-value" id="batteryPower">--</span>
                                <span class="status-unit">W</span>
                            </div>
                        </div>

                        <!-- Grid Power -->
                        <div class="status-card">
                            <div class="status-icon grid">
                                <i class="fas fa-plug"></i>
                            </div>
                            <div class="status-info">
                                <h4>Grid Power</h4>
                                <span class="status-value" id="gridPower">--</span>
                                <span class="status-unit">W</span>
                            </div>
                        </div>

                        <!-- Weather -->
                        <div class="status-card weather-card">
                            <div class="weather-icon" id="weatherIcon">
                                <i class="fas fa-cloud"></i>
                            </div>
                            <div class="weather-info">
                                <h4>Weather</h4>
                                <span class="weather-temp" id="weatherTemp">--¬∞C</span>
                                <span class="weather-desc" id="weatherDesc">Loading...</span>
                                <div class="weather-animation" id="weatherAnimation"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Charging Decision -->
                    <div class="charging-decision" id="chargingDecision">
                        <div class="decision-status">
                            <i class="fas fa-question-circle"></i>
                            <span>Analyzing conditions...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Price Chart -->
            <div class="panel chart-panel">
                <div class="panel-header">
                    <h3><i class="fas fa-chart-line"></i> Price Forecast (24h)</h3>
                    <div class="panel-controls">
                        <select id="chartPeriod" class="select-input">
                            <option value="24h">Next 24 Hours</option>
                            <option value="48h">Next 48 Hours</option>
                            <option value="today">Today</option>
                            <option value="tomorrow">Tomorrow</option>
                        </select>
                    </div>
                </div>
                <div class="panel-content">
                    <div class="chart-container">
                        <canvas id="priceChart"></canvas>
                    </div>
                    <div class="chart-legend">
                        <div class="legend-item very-cheap">
                            <span class="legend-dot"></span> Very Cheap
                        </div>
                        <div class="legend-item cheap">
                            <span class="legend-dot"></span> Cheap
                        </div>
                        <div class="legend-item normal">
                            <span class="legend-dot"></span> Normal
                        </div>
                        <div class="legend-item expensive">
                            <span class="legend-dot"></span> Expensive
                        </div>
                        <div class="legend-item very-expensive">
                            <span class="legend-dot"></span> Very Expensive
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuration Tabs -->
        <div class="config-tabs">
            <div class="tabs-header">
                <button class="tab-btn active" data-tab="tibber">
                    <i class="fas fa-bolt"></i> Tibber Setup
                </button>
                <button class="tab-btn" data-tab="battery">
                    <i class="fas fa-battery-half"></i> Battery Settings
                </button>
                <button class="tab-btn" data-tab="weather">
                    <i class="fas fa-cloud-sun"></i> Weather Conditions
                </button>
                <button class="tab-btn" data-tab="power">
                    <i class="fas fa-lightning-bolt"></i> Power Rules
                </button>
                <button class="tab-btn" data-tab="schedule">
                    <i class="fas fa-clock"></i> Scheduling
                </button>
                <button class="tab-btn" data-tab="advanced">
                    <i class="fas fa-cog"></i> Advanced
                </button>
            </div>

            <div class="tabs-content">
                <!-- Tibber Configuration -->
                <div class="tab-content active" id="tibber-tab">
                    <div class="config-section">
                        <h4><i class="fas fa-key"></i> Tibber API Configuration</h4>
                        <div class="config-grid">
                            <div class="config-item">
                                <label for="tibberApiKey">API Key</label>
                                <div class="input-group">
                                    <input type="password" id="tibberApiKey" class="config-input" placeholder="Enter your Tibber API key">
                                    <button class="btn btn-icon" id="toggleApiKey">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-secondary" id="testTibberBtn">Test</button>
                                </div>
                                <small class="help-text">Get your API key from Tibber Developer Portal</small>
                            </div>

                            <div class="config-item">
                                <label for="country">Country</label>
                                <select id="country" class="config-input">
                                    <option value="">Select Country</option>
                                    <option value="NO">Norway</option>
                                    <option value="SE">Sweden</option>
                                    <option value="DK">Denmark</option>
                                    <option value="FI">Finland</option>
                                    <option value="DE">Germany</option>
                                    <option value="NL">Netherlands</option>
                                    <option value="GB">United Kingdom</option>
                                </select>
                            </div>

                            <div class="config-item">
                                <label for="city">City</label>
                                <select id="city" class="config-input">
                                    <option value="">Select City</option>
                                </select>
                            </div>

                            <div class="config-item">
                                <label for="timezone">Timezone</label>
                                <select id="timezone" class="config-input">
                                    <option value="Europe/Oslo">Europe/Oslo</option>
                                    <option value="Europe/Stockholm">Europe/Stockholm</option>
                                    <option value="Europe/Copenhagen">Europe/Copenhagen</option>
                                    <option value="Europe/Helsinki">Europe/Helsinki</option>
                                    <option value="Europe/Berlin">Europe/Berlin</option>
                                    <option value="Europe/Amsterdam">Europe/Amsterdam</option>
                                    <option value="Europe/London">Europe/London</option>
                                </select>
                            </div>
                        </div>

                        <div class="tibber-status" id="tibberStatus">
                            <div class="status-item">
                                <span class="label">Connection:</span>
                                <span class="value" id="tibberConnection">Not tested</span>
                            </div>
                            <div class="status-item">
                                <span class="label">Last Price Update:</span>
                                <span class="value" id="lastPriceUpdate">Never</span>
                            </div>
                            <div class="status-item">
                                <span class="label">Data Points:</span>
                                <span class="value" id="dataPoints">0</span>
                            </div>
                        </div>
                    </div>

                    <div class="config-section">
                        <h4><i class="fas fa-euro-sign"></i> Price-Based Charging</h4>
                        <div class="config-grid">
                            <div class="config-item full-width">
                                <div class="toggle-group">
                                    <label class="toggle-label">
                                        <input type="checkbox" id="enablePriceCharging" class="toggle-input">
                                        <span class="toggle-slider"></span>
                                        <span class="toggle-text">Enable Price-Based Charging</span>
                                    </label>
                                </div>
                            </div>

                            <div class="config-item full-width">
                                <div class="toggle-group">
                                    <label class="toggle-label">
                                        <input type="checkbox" id="useTibberLevels" class="toggle-input">
                                        <span class="toggle-slider"></span>
                                        <span class="toggle-text">Use Tibber Price Levels (Recommended)</span>
                                    </label>
                                </div>
                            </div>

                            <div class="config-item" id="tibberLevelsConfig">
                                <label>Allowed Price Levels</label>
                                <div class="checkbox-group">
                                    <label class="checkbox-label very-cheap">
                                        <input type="checkbox" id="levelVeryCheap" value="VERY_CHEAP">
                                        <span class="checkmark"></span>
                                        Very Cheap
                                    </label>
                                    <label class="checkbox-label cheap">
                                        <input type="checkbox" id="levelCheap" value="CHEAP">
                                        <span class="checkmark"></span>
                                        Cheap
                                    </label>
                                    <label class="checkbox-label normal">
                                        <input type="checkbox" id="levelNormal" value="NORMAL">
                                        <span class="checkmark"></span>
                                        Normal
                                    </label>
                                </div>
                            </div>

                            <div class="config-item" id="priceThresholdConfig">
                                <label for="maxPriceThreshold">Maximum Price Threshold</label>
                                <div class="input-group">
                                    <input type="number" id="maxPriceThreshold" class="config-input" step="0.01" min="0" max="1">
                                    <span class="input-addon">EUR/kWh</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Battery Settings -->
                <div class="tab-content" id="battery-tab">
                    <div class="config-section">
                        <h4><i class="fas fa-battery-half"></i> Battery Management</h4>
                        <div class="config-grid">
                            <div class="config-item">
                                <label for="emergencySOC">Emergency SoC</label>
                                <div class="input-group">
                                    <input type="number" id="emergencySOC" class="config-input" min="5" max="30">
                                    <span class="input-addon">%</span>
                                </div>
                                <small class="help-text">Force charging below this level</small>
                            </div>

                            <div class="config-item">
                                <label for="minimumSOC">Minimum SoC</label>
                                <div class="input-group">
                                    <input type="number" id="minimumSOC" class="config-input" min="10" max="50">
                                    <span class="input-addon">%</span>
                                </div>
                                <small class="help-text">Preferred minimum charge level</small>
                            </div>

                            <div class="config-item">
                                <label for="targetSOC">Target SoC</label>
                                <div class="input-group">
                                    <input type="number" id="targetSOC" class="config-input" min="50" max="95">
                                    <span class="input-addon">%</span>
                                </div>
                                <small class="help-text">Stop charging at this level</small>
                            </div>

                            <div class="config-item">
                                <label for="maxSOC">Maximum SoC</label>
                                <div class="input-group">
                                    <input type="number" id="maxSOC" class="config-input" min="80" max="100">
                                    <span class="input-addon">%</span>
                                </div>
                                <small class="help-text">Never charge above this level</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Weather Conditions -->
                <div class="tab-content" id="weather-tab">
                    <div class="config-section">
                        <h4><i class="fas fa-cloud-sun"></i> Weather-Based Charging</h4>
                        <div class="config-grid">
                            <div class="config-item full-width">
                                <div class="toggle-group">
                                    <label class="toggle-label">
                                        <input type="checkbox" id="enableWeatherConditions" class="toggle-input">
                                        <span class="toggle-slider"></span>
                                        <span class="toggle-text">Enable Weather-Based Charging</span>
                                    </label>
                                </div>
                            </div>

                            <div class="config-item">
                                <label for="weatherApiKey">OpenWeatherMap API Key</label>
                                <div class="input-group">
                                    <input type="password" id="weatherApiKey" class="config-input" placeholder="Enter API key">
                                    <button class="btn btn-secondary" id="testWeatherBtn">Test</button>
                                </div>
                                <small class="help-text">Get free API key from openweathermap.org</small>
                            </div>

                            <div class="config-item">
                                <label for="cloudCoverThreshold">Cloud Cover Threshold</label>
                                <div class="input-group">
                                    <input type="number" id="cloudCoverThreshold" class="config-input" min="0" max="100">
                                    <span class="input-addon">%</span>
                                </div>
                                <small class="help-text">Trigger charging above this cloud cover</small>
                            </div>

                            <div class="config-item full-width">
                                <div class="toggle-group">
                                    <label class="toggle-label">
                                        <input type="checkbox" id="chargeOnCloudyDays" class="toggle-input">
                                        <span class="toggle-slider"></span>
                                        <span class="toggle-text">Charge on Cloudy Days</span>
                                    </label>
                                </div>
                            </div>

                            <div class="config-item full-width">
                                <div class="toggle-group">
                                    <label class="toggle-label">
                                        <input type="checkbox" id="chargeBeforeStorm" class="toggle-input">
                                        <span class="toggle-slider"></span>
                                        <span class="toggle-text">Charge Before Storms</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Current Weather -->
                        <div class="weather-display" id="currentWeatherDisplay">
                            <h5><i class="fas fa-thermometer-half"></i> Current Weather</h5>
                            <div class="weather-current">
                                <div class="weather-main">
                                    <div class="weather-icon-large" id="currentWeatherIcon">
                                        <i class="fas fa-cloud"></i>
                                    </div>
                                    <div class="weather-temp-large" id="currentWeatherTemp">--¬∞C</div>
                                </div>
                                <div class="weather-details">
                                    <div class="weather-detail">
                                        <span class="label">Description:</span>
                                        <span class="value" id="currentWeatherDesc">--</span>
                                    </div>
                                    <div class="weather-detail">
                                        <span class="label">Cloud Cover:</span>
                                        <span class="value" id="currentCloudCover">--%</span>
                                    </div>
                                    <div class="weather-detail">
                                        <span class="label">Humidity:</span>
                                        <span class="value" id="currentHumidity">--%</span>
                                    </div>
                                    <div class="weather-detail">
                                        <span class="label">Wind:</span>
                                        <span class="value" id="currentWind">-- m/s</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Power Rules -->
                <div class="tab-content" id="power-tab">
                    <div class="config-section">
                        <h4><i class="fas fa-lightning-bolt"></i> Smart Power Conditions</h4>
                        <div class="config-grid">
                            <div class="config-item full-width">
                                <div class="toggle-group">
                                    <label class="toggle-label">
                                        <input type="checkbox" id="enablePowerConditions" class="toggle-input">
                                        <span class="toggle-slider"></span>
                                        <span class="toggle-text">Enable Smart Power Conditions</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Power Rules Builder -->
                        <div class="power-rules" id="powerRulesSection">
                            <h5><i class="fas fa-plus-circle"></i> Custom Power Rules</h5>
                            <button class="btn btn-primary" id="addPowerRuleBtn">
                                <i class="fas fa-plus"></i> Add New Rule
                            </button>
                            
                            <div class="power-rules-list" id="powerRulesList">
                                <!-- Dynamic power rules will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Scheduling -->
                <div class="tab-content" id="schedule-tab">
                    <div class="config-section">
                        <h4><i class="fas fa-clock"></i> Time-Based Conditions</h4>
                        <div class="config-grid">
                            <div class="config-item full-width">
                                <div class="toggle-group">
                                    <label class="toggle-label">
                                        <input type="checkbox" id="enableTimeConditions" class="toggle-input">
                                        <span class="toggle-slider"></span>
                                        <span class="toggle-text">Enable Time-Based Conditions</span>
                                    </label>
                                </div>
                            </div>

                            <div class="config-item full-width">
                                <div class="toggle-group">
                                    <label class="toggle-label">
                                        <input type="checkbox" id="avoidPeakHours" class="toggle-input">
                                        <span class="toggle-slider"></span>
                                        <span class="toggle-text">Avoid Peak Hours</span>
                                    </label>
                                </div>
                            </div>

                            <div class="config-item">
                                <label for="peakStart">Peak Start Time</label>
                                <input type="time" id="peakStart" class="config-input">
                            </div>

                            <div class="config-item">
                                <label for="peakEnd">Peak End Time</label>
                                <input type="time" id="peakEnd" class="config-input">
                            </div>

                            <div class="config-item full-width">
                                <div class="toggle-group">
                                    <label class="toggle-label">
                                        <input type="checkbox" id="preferNightCharging" class="toggle-input">
                                        <span class="toggle-slider"></span>
                                        <span class="toggle-text">Prefer Night Charging</span>
                                    </label>
                                </div>
                            </div>

                            <div class="config-item">
                                <label for="nightStart">Night Start Time</label>
                                <input type="time" id="nightStart" class="config-input">
                            </div>

                            <div class="config-item">
                                <label for="nightEnd">Night End Time</label>
                                <input type="time" id="nightEnd" class="config-input">
                            </div>
                        </div>

                        <!-- Scheduled Charging -->
                        <h5><i class="fas fa-calendar-alt"></i> Scheduled Charging</h5>
                        <div class="config-grid">
                            <div class="config-item full-width">
                                <div class="toggle-group">
                                    <label class="toggle-label">
                                        <input type="checkbox" id="enableScheduledCharging" class="toggle-input">
                                        <span class="toggle-slider"></span>
                                        <span class="toggle-text">Enable Scheduled Charging</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="schedule-builder" id="scheduleBuilder">
                            <button class="btn btn-primary" id="addScheduleBtn">
                                <i class="fas fa-plus"></i> Add Schedule
                            </button>
                            <div class="schedules-list" id="schedulesList">
                                <!-- Dynamic schedules will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Advanced Settings -->
                <div class="tab-content" id="advanced-tab">
                    <div class="config-section">
                        <h4><i class="fas fa-cog"></i> Advanced Settings</h4>
                        
                        <!-- Cooldown Settings -->
                        <h5><i class="fas fa-clock"></i> Cooldown Management</h5>
                        <div class="config-grid">
                            <div class="config-item full-width">
                                <div class="toggle-group">
                                    <label class="toggle-label">
                                        <input type="checkbox" id="enableCooldown" class="toggle-input">
                                        <span class="toggle-slider"></span>
                                        <span class="toggle-text">Enable Cooldown Protection</span>
                                    </label>
                                </div>
                            </div>

                            <div class="config-item">
                                <label for="chargingCooldownMinutes">Charging Cooldown</label>
                                <div class="input-group">
                                    <input type="number" id="chargingCooldownMinutes" class="config-input" min="1" max="180">
                                    <span class="input-addon">minutes</span>
                                </div>
                            </div>

                            <div class="config-item">
                                <label for="maxChargingCyclesPerDay">Max Cycles Per Day</label>
                                <div class="input-group">
                                    <input type="number" id="maxChargingCyclesPerDay" class="config-input" min="1" max="50">
                                    <span class="input-addon">cycles</span>
                                </div>
                            </div>
                        </div>

                        <!-- Inverter Status -->
                        <h5><i class="fas fa-microchip"></i> Inverter Status</h5>
                        <div class="inverter-status" id="inverterStatusDisplay">
                            <!-- Inverter status will be populated dynamically -->
                        </div>

                        <!-- System Health -->
                        <h5><i class="fas fa-heartbeat"></i> System Health</h5>
                        <div class="health-indicators" id="healthIndicators">
                            <!-- Health indicators will be populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions Footer -->
        <div class="actions-footer">
            <div class="actions-left">
                <button class="btn btn-outline" id="resetSettingsBtn">
                    <i class="fas fa-undo"></i> Reset to Defaults
                </button>
                <button class="btn btn-outline" id="exportSettingsBtn">
                    <i class="fas fa-download"></i> Export Settings
                </button>
                <button class="btn btn-outline" id="importSettingsBtn">
                    <i class="fas fa-upload"></i> Import Settings
                </button>
            </div>
            <div class="actions-right">
                <button class="btn btn-secondary" id="disableBtn">
                    <i class="fas fa-power-off"></i> Disable
                </button>
                <button class="btn btn-primary" id="saveSettingsBtn">
                    <i class="fas fa-save"></i> Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="powerRuleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Power Rule Configuration</h3>
                <button class="modal-close" id="closePowerRuleModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="config-grid">
                    <div class="config-item full-width">
                        <label for="ruleName">Rule Name</label>
                        <input type="text" id="ruleName" class="config-input" placeholder="Enter rule name">
                    </div>
                    <div class="config-item full-width">
                        <label for="rulePriority">Priority</label>
                        <select id="rulePriority" class="config-input">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div class="config-item full-width">
                        <label for="ruleDescription">Description</label>
                        <textarea id="ruleDescription" class="config-input" rows="2" placeholder="Describe what this rule does"></textarea>
                    </div>
                </div>
                
                <h4>Conditions</h4>
                <div id="ruleConditions">
                    <!-- Dynamic conditions will be added here -->
                </div>
                <button class="btn btn-secondary" id="addConditionBtn">
                    <i class="fas fa-plus"></i> Add Condition
                </button>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelRuleBtn">Cancel</button>
                <button class="btn btn-primary" id="saveRuleBtn">Save Rule</button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="<%= ingress_path %>/js/dynamic-pricing.js"></script>

 <script>
    // Dynamic Pricing Dashboard - Complete JavaScript Implementation
// Enhanced with real-time data updates and Tibber integration

class DynamicPricingDashboard {
    constructor() {
        this.config = {};
        this.status = {};
        this.pricingData = [];
        this.chart = null;
        this.updateInterval = null;
        this.statusInterval = null;
        this.priceChart = null;
        this.currentEditingRule = null;
        this.powerRules = [];
        this.schedules = [];
        
        // Country/City mapping
        this.cityMap = {
            'NO': [
                { name: 'Oslo', lat: 59.9139, lon: 10.7522 },
                { name: 'Bergen', lat: 60.3913, lon: 5.3221 },
                { name: 'Trondheim', lat: 63.4305, lon: 10.3951 },
                { name: 'Stavanger', lat: 58.9700, lon: 5.7331 }
            ],
            'SE': [
                { name: 'Stockholm', lat: 59.3293, lon: 18.0686 },
                { name: 'G√∂teborg', lat: 57.7089, lon: 11.9746 },
                { name: 'Malm√∂', lat: 55.6050, lon: 13.0038 },
                { name: 'Uppsala', lat: 59.8586, lon: 17.6389 }
            ],
            'DK': [
                { name: 'Copenhagen', lat: 55.6761, lon: 12.5683 },
                { name: '√Örhus', lat: 56.1629, lon: 10.2039 },
                { name: 'Odense', lat: 55.4038, lon: 10.4024 },
                { name: 'Aalborg', lat: 57.0488, lon: 9.9217 }
            ],
            'FI': [
                { name: 'Helsinki', lat: 60.1699, lon: 24.9384 },
                { name: 'Espoo', lat: 60.2055, lon: 24.6559 },
                { name: 'Tampere', lat: 61.4991, lon: 23.7871 },
                { name: 'Vantaa', lat: 60.2934, lon: 25.0378 }
            ],
            'DE': [
                { name: 'Berlin', lat: 52.5200, lon: 13.4050 },
                { name: 'Hamburg', lat: 53.5511, lon: 9.9937 },
                { name: 'Munich', lat: 48.1351, lon: 11.5820 },
                { name: 'Cologne', lat: 50.9375, lon: 6.9603 },
                { name: 'Frankfurt', lat: 50.1109, lon: 8.6821 }
            ],
            'NL': [
                { name: 'Amsterdam', lat: 52.3676, lon: 4.9041 },
                { name: 'Rotterdam', lat: 51.9244, lon: 4.4777 },
                { name: 'The Hague', lat: 52.0705, lon: 4.3007 },
                { name: 'Utrecht', lat: 52.0907, lon: 5.1214 }
            ],
            'GB': [
                { name: 'London', lat: 51.5074, lon: -0.1278 },
                { name: 'Manchester', lat: 53.4808, lon: -2.2426 },
                { name: 'Birmingham', lat: 52.4862, lon: -1.8904 },
                { name: 'Leeds', lat: 53.8008, lon: -1.5491 }
            ]
        };

        this.init();
    }

    async init() {
        console.log('üîã Initializing Dynamic Pricing Dashboard...');
        
        // Initialize components
        this.setupEventListeners();
        this.setupTabs();
        this.initializeChart();
        this.setupCountryCityHandler();
        
        // Load initial data
        await this.loadSettings();
        await this.loadStatus();
        await this.loadPricingData();
        
        // Start real-time updates
        this.startRealTimeUpdates();
        
        // Update connection status
        this.updateConnectionStatus();
        
        console.log('‚úÖ Dynamic Pricing Dashboard initialized successfully');
    }

    setupEventListeners() {
        // Quick Action Buttons
        document.getElementById('manualChargeBtn')?.addEventListener('click', () => this.manualCharge(true));
        document.getElementById('manualStopBtn')?.addEventListener('click', () => this.manualCharge(false));
        document.getElementById('refreshDataBtn')?.addEventListener('click', () => this.refreshAllData());
        document.getElementById('testConditionsBtn')?.addEventListener('click', () => this.testConditions());
        
        // Configuration buttons
        document.getElementById('saveSettingsBtn')?.addEventListener('click', () => this.saveSettings());
        document.getElementById('disableBtn')?.addEventListener('click', () => this.toggleEnable(false));
        document.getElementById('resetSettingsBtn')?.addEventListener('click', () => this.resetSettings());
        document.getElementById('exportSettingsBtn')?.addEventListener('click', () => this.exportSettings());
        document.getElementById('importSettingsBtn')?.addEventListener('click', () => this.importSettings());
        
        // Test buttons
        document.getElementById('testTibberBtn')?.addEventListener('click', () => this.testTibberConnection());
        document.getElementById('testWeatherBtn')?.addEventListener('click', () => this.testWeatherConnection());
        
        // Status refresh buttons
        document.getElementById('refreshStatusBtn')?.addEventListener('click', () => this.loadStatus());
        
        // API key visibility toggle
        document.getElementById('toggleApiKey')?.addEventListener('click', () => this.toggleApiKeyVisibility());
        
        // Chart period selector
        document.getElementById('chartPeriod')?.addEventListener('change', (e) => this.updateChartPeriod(e.target.value));
        
        // Power Rules
        document.getElementById('addPowerRuleBtn')?.addEventListener('click', () => this.openPowerRuleModal());
        document.getElementById('saveRuleBtn')?.addEventListener('click', () => this.savePowerRule());
        document.getElementById('cancelRuleBtn')?.addEventListener('click', () => this.closePowerRuleModal());
        document.getElementById('closePowerRuleModal')?.addEventListener('click', () => this.closePowerRuleModal());
        document.getElementById('addConditionBtn')?.addEventListener('click', () => this.addCondition());
        
        // Schedule management
        document.getElementById('addScheduleBtn')?.addEventListener('click', () => this.addSchedule());
        
        // Toggle handlers for enabling/disabling sections
        this.setupToggleHandlers();
        
        // Form change handlers
        this.setupFormChangeHandlers();
    }

    setupToggleHandlers() {
        // Price-based charging toggle
        const priceToggle = document.getElementById('enablePriceCharging');
        if (priceToggle) {
            priceToggle.addEventListener('change', () => {
                this.toggleSection('tibberLevelsConfig', priceToggle.checked);
                this.toggleSection('priceThresholdConfig', priceToggle.checked);
            });
        }

        // Tibber levels vs price threshold
        const tibberLevelsToggle = document.getElementById('useTibberLevels');
        if (tibberLevelsToggle) {
            tibberLevelsToggle.addEventListener('change', () => {
                document.getElementById('tibberLevelsConfig').style.display = 
                    tibberLevelsToggle.checked ? 'block' : 'none';
                document.getElementById('priceThresholdConfig').style.display = 
                    tibberLevelsToggle.checked ? 'none' : 'block';
            });
        }

        // Weather conditions toggle
        const weatherToggle = document.getElementById('enableWeatherConditions');
        if (weatherToggle) {
            weatherToggle.addEventListener('change', () => {
                this.toggleSection('currentWeatherDisplay', weatherToggle.checked);
            });
        }

        // Power conditions toggle
        const powerToggle = document.getElementById('enablePowerConditions');
        if (powerToggle) {
            powerToggle.addEventListener('change', () => {
                this.toggleSection('powerRulesSection', powerToggle.checked);
            });
        }

        // Time conditions toggle
        const timeToggle = document.getElementById('enableTimeConditions');
        if (timeToggle) {
            timeToggle.addEventListener('change', () => {
                this.updateTimeConditionsVisibility();
            });
        }

        // Scheduled charging toggle
        const scheduleToggle = document.getElementById('enableScheduledCharging');
        if (scheduleToggle) {
            scheduleToggle.addEventListener('change', () => {
                this.toggleSection('scheduleBuilder', scheduleToggle.checked);
            });
        }

        // Cooldown toggle
        const cooldownToggle = document.getElementById('enableCooldown');
        if (cooldownToggle) {
            cooldownToggle.addEventListener('change', () => {
                // Cooldown specific toggles handled in form
            });
        }
    }

    setupFormChangeHandlers() {
        // Auto-save on certain field changes
        const autoSaveFields = [
            'emergencySOC', 'minimumSOC', 'targetSOC', 'maxSOC',
            'cloudCoverThreshold', 'peakStart', 'peakEnd', 
            'nightStart', 'nightEnd', 'chargingCooldownMinutes', 
            'maxChargingCyclesPerDay'
        ];

        autoSaveFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('blur', () => {
                    // Auto-save with debouncing
                    clearTimeout(this.autoSaveTimeout);
                    this.autoSaveTimeout = setTimeout(() => this.saveSettings(), 2000);
                });
            }
        });
    }

    setupTabs() {
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.getAttribute('data-tab');
                
                // Remove active class from all tabs and contents
                tabBtns.forEach(b => b.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding content
                btn.classList.add('active');
                const targetContent = document.getElementById(`${tabId}-tab`);
                if (targetContent) {
                    targetContent.classList.add('active');
                }
            });
        });
    }

    setupCountryCityHandler() {
        const countrySelect = document.getElementById('country');
        const citySelect = document.getElementById('city');
        const timezoneSelect = document.getElementById('timezone');

        if (countrySelect && citySelect) {
            countrySelect.addEventListener('change', () => {
                const country = countrySelect.value;
                this.updateCityOptions(country);
                this.updateTimezone(country);
            });
        }
    }

    updateCityOptions(countryCode) {
        const citySelect = document.getElementById('city');
        if (!citySelect) return;

        // Clear existing options
        citySelect.innerHTML = '<option value="">Select City</option>';

        if (this.cityMap[countryCode]) {
            this.cityMap[countryCode].forEach(city => {
                const option = document.createElement('option');
                option.value = city.name;
                option.textContent = city.name;
                citySelect.appendChild(option);
            });
        }
    }

    updateTimezone(countryCode) {
        const timezoneSelect = document.getElementById('timezone');
        if (!timezoneSelect) return;

        const timezoneMap = {
            'NO': 'Europe/Oslo',
            'SE': 'Europe/Stockholm',
            'DK': 'Europe/Copenhagen',
            'FI': 'Europe/Helsinki',
            'DE': 'Europe/Berlin',
            'NL': 'Europe/Amsterdam',
            'GB': 'Europe/London'
        };

        if (timezoneMap[countryCode]) {
            timezoneSelect.value = timezoneMap[countryCode];
        }
    }

    toggleSection(sectionId, show) {
        const section = document.getElementById(sectionId);
        if (section) {
            section.style.display = show ? 'block' : 'none';
        }
    }

    updateTimeConditionsVisibility() {
        const enabled = document.getElementById('enableTimeConditions')?.checked;
        const avoidPeak = document.getElementById('avoidPeakHours')?.checked;
        const preferNight = document.getElementById('preferNightCharging')?.checked;

        // Show/hide peak hour controls
        ['peakStart', 'peakEnd'].forEach(id => {
            const field = document.getElementById(id)?.parentElement;
            if (field) field.style.display = (enabled && avoidPeak) ? 'block' : 'none';
        });

        // Show/hide night charging controls
        ['nightStart', 'nightEnd'].forEach(id => {
            const field = document.getElementById(id)?.parentElement;
            if (field) field.style.display = (enabled && preferNight) ? 'block' : 'none';
        });
    }

    initializeChart() {
        const ctx = document.getElementById('priceChart');
        if (!ctx) return;

        this.priceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Price',
                    data: [],
                    borderColor: 'rgb(37, 99, 235)',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.1,
                    pointBackgroundColor: function(context) {
                        const level = context.raw?.level;
                        const colors = {
                            'VERY_CHEAP': '#10b981',
                            'CHEAP': '#22c55e',
                            'NORMAL': '#64748b',
                            'EXPENSIVE': '#f59e0b',
                            'VERY_EXPENSIVE': '#ef4444'
                        };
                        return colors[level] || '#64748b';
                    },
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const dataPoint = context.raw;
                                const level = dataPoint?.level || 'Unknown';
                                return `${context.formattedValue} EUR/kWh (${level})`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            maxRotation: 45
                        }
                    },
                    y: {
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        title: {
                            display: true,
                            text: 'Price (EUR/kWh)'
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });
    }

    updateChartPeriod(period) {
        console.log('üìä Updating chart period:', period);
        this.loadPricingData(period);
    }

    async loadSettings() {
        try {
            console.log('üîß Loading dynamic pricing settings...');
            const response = await fetch('/api/dynamic-pricing/settings');
            const data = await response.json();

            if (data.success) {
                this.config = data.config;
                this.populateSettingsForm(this.config);
                this.updateInverterStatus(data.inverterStatus);
                console.log('‚úÖ Settings loaded successfully');
            } else {
                throw new Error(data.error || 'Failed to load settings');
            }
        } catch (error) {
            console.error('‚ùå Error loading settings:', error);
            this.showToast('Failed to load settings: ' + error.message, 'error');
        }
    }

    populateSettingsForm(config) {
        // Tibber settings
        this.setFieldValue('tibberApiKey', this.maskApiKey(config.tibberApiKey || ''));
        this.setFieldValue('country', config.country || 'DE');
        this.setFieldValue('city', config.city || 'Berlin');
        this.setFieldValue('timezone', config.timezone || 'Europe/Berlin');
        
        // Update city options based on country
        if (config.country) {
            this.updateCityOptions(config.country);
            this.setFieldValue('city', config.city);
        }

        // Price-based charging
        const priceSettings = config.priceBasedCharging || {};
        this.setCheckbox('enablePriceCharging', priceSettings.enabled);
        this.setCheckbox('useTibberLevels', priceSettings.useTibberLevels);
        this.setFieldValue('maxPriceThreshold', priceSettings.maxPriceThreshold || 0.20);

        // Tibber levels
        const allowedLevels = priceSettings.allowedTibberLevels || ['VERY_CHEAP', 'CHEAP'];
        ['VERY_CHEAP', 'CHEAP', 'NORMAL'].forEach(level => {
            const checkbox = document.getElementById(`level${level.charAt(0) + level.slice(1).toLowerCase().replace('_', '')}`);
            if (checkbox) checkbox.checked = allowedLevels.includes(level);
        });

        // Battery settings
        const batterySettings = config.battery || {};
        this.setFieldValue('emergencySOC', batterySettings.emergencySoC || 15);
        this.setFieldValue('minimumSOC', batterySettings.minimumSoC || 20);
        this.setFieldValue('targetSOC', batterySettings.targetSoC || 80);
        this.setFieldValue('maxSOC', batterySettings.maxSoC || 95);

        // Weather conditions
        const weatherSettings = config.weatherConditions || {};
        this.setCheckbox('enableWeatherConditions', weatherSettings.enabled);
        this.setFieldValue('weatherApiKey', this.maskApiKey(weatherSettings.weatherApiKey || ''));
        this.setFieldValue('cloudCoverThreshold', weatherSettings.cloudCoverThreshold || 70);
        this.setCheckbox('chargeOnCloudyDays', weatherSettings.chargeOnCloudyDays);
        this.setCheckbox('chargeBeforeStorm', weatherSettings.chargeBeforeStorm);

        // Time conditions
        const timeSettings = config.timeConditions || {};
        this.setCheckbox('enableTimeConditions', timeSettings.enabled);
        this.setCheckbox('avoidPeakHours', timeSettings.avoidPeakHours);
        this.setCheckbox('preferNightCharging', timeSettings.preferNightCharging);
        this.setFieldValue('peakStart', timeSettings.peakStart || '17:00');
        this.setFieldValue('peakEnd', timeSettings.peakEnd || '21:00');
        this.setFieldValue('nightStart', timeSettings.nightStart || '22:00');
        this.setFieldValue('nightEnd', timeSettings.nightEnd || '06:00');

        // Smart power conditions
        const powerSettings = config.smartPowerConditions || {};
        this.setCheckbox('enablePowerConditions', powerSettings.enabled);
        this.powerRules = powerSettings.rules || [];
        this.updatePowerRulesList();

        // Scheduled charging
        this.setCheckbox('enableScheduledCharging', config.scheduledCharging);
        this.schedules = config.chargingHours || [];
        this.updateSchedulesList();

        // Cooldown settings
        const cooldownSettings = config.cooldown || {};
        this.setCheckbox('enableCooldown', cooldownSettings.enabled);
        this.setFieldValue('chargingCooldownMinutes', cooldownSettings.chargingCooldownMinutes || 30);
        this.setFieldValue('maxChargingCyclesPerDay', cooldownSettings.maxChargingCyclesPerDay || 8);

        // Update visibility based on toggles
        this.updateAllToggleVisibility();
    }

    updateAllToggleVisibility() {
        // Update all conditional visibility based on current toggle states
        setTimeout(() => {
            const priceToggle = document.getElementById('enablePriceCharging');
            if (priceToggle) priceToggle.dispatchEvent(new Event('change'));

            const tibberToggle = document.getElementById('useTibberLevels');
            if (tibberToggle) tibberToggle.dispatchEvent(new Event('change'));

            const weatherToggle = document.getElementById('enableWeatherConditions');
            if (weatherToggle) weatherToggle.dispatchEvent(new Event('change'));

            const powerToggle = document.getElementById('enablePowerConditions');
            if (powerToggle) powerToggle.dispatchEvent(new Event('change'));

            const timeToggle = document.getElementById('enableTimeConditions');
            if (timeToggle) this.updateTimeConditionsVisibility();

            const scheduleToggle = document.getElementById('enableScheduledCharging');
            if (scheduleToggle) scheduleToggle.dispatchEvent(new Event('change'));
        }, 100);
    }

    setFieldValue(fieldId, value) {
        const field = document.getElementById(fieldId);
        if (field && value !== undefined && value !== null) {
            field.value = value;
        }
    }

    setCheckbox(checkboxId, checked) {
        const checkbox = document.getElementById(checkboxId);
        if (checkbox) {
            checkbox.checked = !!checked;
        }
    }

    maskApiKey(apiKey) {
        if (!apiKey || apiKey.length < 8) return apiKey;
        return apiKey.substring(0, 8) + '...' + apiKey.substring(apiKey.length - 4);
    }

    async loadStatus() {
        try {
            const response = await fetch('/api/dynamic-pricing/status');
            const data = await response.json();

            if (data.success) {
                this.status = data.status;
                this.updateStatusDisplay(data);
                this.updateConnectionStatus(true);
            } else {
                throw new Error(data.error || 'Failed to load status');
            }
        } catch (error) {
            console.error('‚ùå Error loading status:', error);
            this.updateConnectionStatus(false);
        }
    }

    updateStatusDisplay(data) {
        const { status, systemState } = data;

        // Update system state displays
        this.updateElement('batterySOC', this.formatNumber(systemState.battery_soc) || '--');
        this.updateElement('pvPower', this.formatNumber(systemState.pv_power) || '--');
        this.updateElement('loadPower', this.formatNumber(systemState.load) || '--');
        this.updateElement('gridPower', this.formatNumber(systemState.grid_power) || '--');
        this.updateElement('batteryPower', this.formatNumber(systemState.battery_power) || '--');

        // Update current price with proper handling
        if (status.currentPrice) {
            this.updateElement('currentPrice', this.formatPrice(status.currentPrice.price));
            const currency = status.currentPrice.currency || 'EUR';
            this.updateElement('currentCurrency', currency + '/kWh');
            this.updatePriceLevel(status.currentPrice.level);
        } else {
            this.updateElement('currentPrice', '--');
            this.updateElement('currentCurrency', 'EUR/kWh');
            this.updatePriceLevel(null);
        }

        // Update charging decision
        if (status.currentDecision) {
            this.updateChargingDecision(status.currentDecision);
        }

        // Update learner mode status
        this.updateLearnerModeStatus(data.learnerModeActive);

        // Update Tibber status
        this.updateTibberStatus(status.tibberIntegration);

        // Update inverter status
        this.updateInverterStatus(data.inverterStatus);

        // Update health indicators
        this.updateHealthIndicators(status);

        // Update weather display if weather is enabled
        if (status.conditions?.weather?.enabled) {
            this.updateWeatherDisplay();
        }
    }

    updateElement(elementId, value) {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = value;
        }
    }

    formatNumber(num) {
        if (num === null || num === undefined) return '--';
        return Number(num).toLocaleString();
    }

    formatPrice(price) {
        if (price === null || price === undefined) return '--';
        return Number(price).toFixed(4);
    }

    updatePriceLevel(level) {
        const element = document.getElementById('priceLevel');
        if (element) {
            if (level) {
                element.textContent = level.replace('_', ' ');
                element.className = 'price-level ' + level.toLowerCase().replace('_', '-');
            } else {
                element.textContent = '';
                element.className = 'price-level';
            }
        }
    }

    updateChargingDecision(decision) {
        const element = document.getElementById('chargingDecision');
        if (!element) return;

        const shouldCharge = decision.shouldCharge;
        const reason = decision.reason;

        element.className = 'charging-decision ' + 
            (shouldCharge === null ? 'analyzing' : 
             shouldCharge ? 'should-charge' : 'should-not-charge');

        const iconClass = shouldCharge === null ? 'fa-question-circle' : 
                         shouldCharge ? 'fa-play-circle' : 'fa-stop-circle';

        const status = shouldCharge === null ? 'Analyzing conditions...' : 
                      shouldCharge ? `‚úÖ Should charge: ${reason}` : 
                      `‚ùå Should not charge: ${reason}`;

        element.innerHTML = `
            <div class="decision-status">
                <i class="fas ${iconClass}"></i>
                <span>${status}</span>
            </div>
        `;
    }

    updateConnectionStatus(connected = true) {
        const statusElement = document.getElementById('connectionStatus');
        if (!statusElement) return;

        if (connected) {
            statusElement.className = 'status-indicator connected';
            statusElement.innerHTML = '<i class="fas fa-circle"></i> <span>Connected</span>';
        } else {
            statusElement.className = 'status-indicator disconnected';
            statusElement.innerHTML = '<i class="fas fa-circle"></i> <span>Disconnected</span>';
        }
    }

    updateLearnerModeStatus(active) {
        const statusElement = document.getElementById('learnerModeStatus');
        if (!statusElement) return;

        statusElement.className = 'learner-mode-indicator ' + (active ? 'active' : 'inactive');
        statusElement.innerHTML = `<i class="fas fa-graduation-cap"></i> <span>${active ? 'Active' : 'Inactive'}</span>`;

        // Update quick action buttons
        const chargeBtn = document.getElementById('manualChargeBtn');
        const stopBtn = document.getElementById('manualStopBtn');
        
        if (chargeBtn) chargeBtn.disabled = !active;
        if (stopBtn) stopBtn.disabled = !active;
    }

    updateTibberStatus(tibberStatus) {
        if (!tibberStatus) return;

        this.updateElement('tibberConnection', tibberStatus.enabled ? 'Connected' : 'Not configured');
        this.updateElement('lastPriceUpdate', 'Live' );
        this.updateElement('dataPoints', '48+ hours');
    }

    updateInverterStatus(inverterStatus) {
        const container = document.getElementById('inverterStatusDisplay');
        if (!container || !inverterStatus) return;

        const { totalInverters, typesSummary } = inverterStatus;

        container.innerHTML = '';

        if (totalInverters === 0) {
            container.innerHTML = '<p>No inverters detected yet. Waiting for MQTT messages...</p>';
            return;
        }

        Object.entries(typesSummary).forEach(([type, count]) => {
            const item = document.createElement('div');
            item.className = 'inverter-item';
            
            item.innerHTML = `
                <h6>${count}x Inverter${count > 1 ? 's' : ''}</h6>
                <div class="inverter-type ${type}">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                <p>${this.getInverterTypeDescription(type)}</p>
            `;
            
            container.appendChild(item);
        });
    }

    getInverterTypeDescription(type) {
        const descriptions = {
            'legacy': 'Uses energy_pattern and grid_charge commands',
            'new': 'Uses charger_source_priority and output_source_priority commands',
            'hybrid': 'Supports both legacy and new command sets',
            'unknown': 'Type detection in progress'
        };
        return descriptions[type] || 'Unknown inverter type';
    }

    updateHealthIndicators(status) {
        const container = document.getElementById('healthIndicators');
        if (!container) return;

        const indicators = [
            {
                icon: 'fas fa-database',
                title: 'API Connection',
                status: status.enabled ? 'good' : 'warning',
                description: status.enabled ? 'Connected' : 'Disabled'
            },
            {
                icon: 'fas fa-clock',
                title: 'Cooldown Status',
                status: status.cooldown?.inCooldown ? 'warning' : 'good',
                description: status.cooldown?.inCooldown ? 'In cooldown' : 'Ready'
            },
            {
                icon: 'fas fa-chart-line',
                title: 'Price Data',
                status: status.currentPrice ? 'good' : 'error',
                description: status.currentPrice ? 'Live data' : 'No data'
            }
        ];

        container.innerHTML = '';

        indicators.forEach(indicator => {
            const item = document.createElement('div');
            item.className = 'health-item';
            
            item.innerHTML = `
                <div class="health-icon ${indicator.status}">
                    <i class="${indicator.icon}"></i>
                </div>
                <div class="health-info">
                    <h6>${indicator.title}</h6>
                    <p>${indicator.description}</p>
                </div>
            `;
            
            container.appendChild(item);
        });
    }

    async updateWeatherDisplay() {
        try {
            const response = await fetch('/api/dynamic-pricing/test-conditions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ testType: 'weather' })
            });

            const data = await response.json();
            if (data.success && data.result.success) {
                const weather = data.result.forecast[0].weather[0];
                const main = data.result.forecast[0].main;
                const clouds = data.result.forecast[0].clouds;

                // Update status card weather
                this.updateElement('weatherTemp', Math.round(main.temp) + '¬∞C');
                this.updateElement('weatherDesc', weather.description);

                // Update detailed weather display
                this.updateElement('currentWeatherTemp', Math.round(main.temp) + '¬∞C');
                this.updateElement('currentWeatherDesc', weather.description);
                this.updateElement('currentCloudCover', clouds.all + '%');
                this.updateElement('currentHumidity', main.humidity + '%');

                // Update weather icons
                this.updateWeatherIcons(weather.main);
            }
        } catch (error) {
            console.log('Weather update failed:', error.message);
        }
    }

    updateWeatherIcons(weatherMain) {
        const iconClass = this.getWeatherIconClass(weatherMain);
        const weatherIcon = document.getElementById('weatherIcon');
        const currentWeatherIcon = document.getElementById('currentWeatherIcon');

        if (weatherIcon) {
            weatherIcon.className = `weather-icon ${iconClass}`;
        }
        if (currentWeatherIcon) {
            currentWeatherIcon.className = `weather-icon-large ${iconClass}`;
        }
    }

    getWeatherIconClass(weatherMain) {
        const iconMap = {
            'Clear': 'sunny',
            'Clouds': 'cloudy',
            'Rain': 'rainy',
            'Drizzle': 'rainy',
            'Thunderstorm': 'stormy',
            'Snow': 'snowy',
            'Mist': 'cloudy',
            'Fog': 'cloudy'
        };
        return iconMap[weatherMain] || 'cloudy';
    }

    async loadPricingData(period = '24h') {
        try {
            const response = await fetch('/api/dynamic-pricing/pricing-data');
            const data = await response.json();

            if (data.success) {
                this.pricingData = data.data || [];
                this.updateChart(period);
            } else {
                throw new Error(data.error || 'Failed to load pricing data');
            }
        } catch (error) {
            console.error('‚ùå Error loading pricing data:', error);
        }
    }

    updateChart(period = '24h') {
        if (!this.priceChart || !this.pricingData.length) return;

        let filteredData = [...this.pricingData];
        const now = new Date();

        // Filter data based on period
        switch (period) {
            case '24h':
                // Get next 24 data points (hours)
                filteredData = this.pricingData.slice(0, 24);
                break;
            case '48h':
                // Get next 48 data points (hours)
                filteredData = this.pricingData.slice(0, 48);
                break;
            case 'today':
                // Filter for today's data
                filteredData = this.pricingData.filter(item => {
                    const itemDate = new Date(item.timestamp);
                    return itemDate.toDateString() === now.toDateString();
                });
                break;
            case 'tomorrow':
                // Filter for tomorrow's data
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                filteredData = this.pricingData.filter(item => {
                    const itemDate = new Date(item.timestamp);
                    return itemDate.toDateString() === tomorrow.toDateString();
                });
                break;
        }

        // Ensure we have data
        if (filteredData.length === 0) {
            console.log('No pricing data available for period:', period);
            return;
        }

        // Prepare chart data
        const labels = filteredData.map(item => {
            const date = new Date(item.timestamp);
            return date.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
        });

        const prices = filteredData.map(item => ({
            x: item.timestamp,
            y: item.price,
            level: item.level
        }));

        // Update chart
        this.priceChart.data.labels = labels;
        this.priceChart.data.datasets[0].data = prices;
        this.priceChart.update('none'); // Disable animation for smoother updates
    }

    startRealTimeUpdates() {
        // Update status every 10 seconds
        this.statusInterval = setInterval(() => {
            this.loadStatus();
        }, 10000);

        // Update pricing data every 5 minutes
        this.updateInterval = setInterval(() => {
            this.loadPricingData();
        }, 300000);

        // Update current price every 30 seconds
        setInterval(async () => {
            try {
                const response = await fetch('/api/dynamic-pricing/current-price');
                const data = await response.json();
                if (data.success && data.currentPrice) {
                    this.updateElement('currentPrice', this.formatPrice(data.currentPrice.price));
                    const currency = data.currentPrice.currency || 'EUR';
                    this.updateElement('currentCurrency', currency + '/kWh');
                    this.updatePriceLevel(data.currentPrice.level);
                }
            } catch (error) {
                // Silently handle errors for background updates
            }
        }, 30000);

        console.log('üîÑ Real-time updates started');
    }

    stopRealTimeUpdates() {
        if (this.statusInterval) {
            clearInterval(this.statusInterval);
            this.statusInterval = null;
        }
        if (this.updateInterval) {
            clearInterval(this.updateInterval);
            this.updateInterval = null;
        }
        console.log('‚èπÔ∏è Real-time updates stopped');
    }

    async manualCharge(enable) {
        try {
            const action = enable ? 'enable' : 'disable';
            console.log(`üîã Manual charging: ${action}`);

            const response = await fetch('/api/dynamic-pricing/manual-charge', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enable })
            });

            const data = await response.json();
            
            if (data.success) {
                this.showToast(data.message, 'success');
                // Refresh status to show updated state
                setTimeout(() => this.loadStatus(), 1000);
            } else {
                // Show conditions not met message with option to force
                if (data.canForce) {
                    const force = confirm(`${data.message}\n\nDo you want to force this action?`);
                    if (force) {
                        return this.manualChargeForce(enable);
                    }
                }
                this.showToast(data.message || 'Command failed', 'error');
            }
        } catch (error) {
            console.error('‚ùå Error sending manual charge command:', error);
            this.showToast('Failed to send command: ' + error.message, 'error');
        }
    }

    async manualChargeForce(enable) {
        try {
            const response = await fetch('/api/dynamic-pricing/manual-charge', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enable, force: true })
            });

            const data = await response.json();
            
            if (data.success) {
                this.showToast(data.message, 'success');
                setTimeout(() => this.loadStatus(), 1000);
            } else {
                this.showToast(data.message || 'Forced command failed', 'error');
            }
        } catch (error) {
            console.error('‚ùå Error sending forced charge command:', error);
            this.showToast('Failed to send forced command: ' + error.message, 'error');
        }
    }

    async refreshAllData() {
        console.log('üîÑ Refreshing all data...');
        
        // Show loading state
        const btn = document.getElementById('refreshDataBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
        btn.disabled = true;

        try {
            // Refresh pricing data first
            const priceResponse = await fetch('/api/dynamic-pricing/refresh-prices', {
                method: 'POST'
            });

            // Load all data
            await Promise.all([
                this.loadSettings(),
                this.loadStatus(),
                this.loadPricingData()
            ]);

            this.showToast('Data refreshed successfully', 'success');
        } catch (error) {
            console.error('‚ùå Error refreshing data:', error);
            this.showToast('Failed to refresh data: ' + error.message, 'error');
        } finally {
            // Restore button
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    async testConditions() {
        const testTypes = ['tibber', 'price', 'weather', 'time', 'smartpower', 'cooldown'];
        let results = [];

        for (const testType of testTypes) {
            try {
                const response = await fetch('/api/dynamic-pricing/test-conditions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ testType })
                });

                const data = await response.json();
                results.push({ testType, success: data.success, result: data.result });
            } catch (error) {
                results.push({ testType, success: false, error: error.message });
            }
        }

        // Show results
        this.showTestResults(results);
    }

    showTestResults(results) {
        const modal = document.createElement('div');
        modal.className = 'modal active';
        
        const resultsHtml = results.map(result => {
            const status = result.success ? '‚úÖ' : '‚ùå';
            const message = result.success ? 
                (typeof result.result === 'string' ? result.result : 'Test passed') :
                (result.error || 'Test failed');
            
            return `
                <div class="test-result-item">
                    <strong>${status} ${result.testType.toUpperCase()}</strong><br>
                    <small>${message}</small>
                </div>
            `;
        }).join('');

        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Condition Test Results</h3>
                    <button class="modal-close" onclick="this.closest('.modal').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    ${resultsHtml}
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="this.closest('.modal').remove()">Close</button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
    }

    async saveSettings() {
        try {
            console.log('üíæ Saving settings...');

            const settings = this.gatherSettingsFromForm();
            
            const response = await fetch('/api/dynamic-pricing/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });

            const data = await response.json();
            
            if (data.success) {
                this.showToast('Settings saved successfully', 'success');
                // Refresh data to reflect changes
                setTimeout(() => {
                    this.loadSettings();
                    this.loadStatus();
                }, 1000);
            } else {
                throw new Error(data.error || 'Failed to save settings');
            }
        } catch (error) {
            console.error('‚ùå Error saving settings:', error);
            this.showToast('Failed to save settings: ' + error.message, 'error');
        }
    }

    gatherSettingsFromForm() {
        // Get Tibber API key (handle masked values)
        let tibberApiKey = document.getElementById('tibberApiKey')?.value || '';
        if (tibberApiKey.includes('...')) {
            tibberApiKey = this.config.tibberApiKey; // Keep existing if masked
        }

        // Get weather API key (handle masked values)  
        let weatherApiKey = document.getElementById('weatherApiKey')?.value || '';
        if (weatherApiKey.includes('...')) {
            weatherApiKey = this.config.weatherConditions?.weatherApiKey; // Keep existing if masked
        }

        // Gather Tibber levels
        const allowedTibberLevels = [];
        ['VERY_CHEAP', 'CHEAP', 'NORMAL'].forEach(level => {
            const checkbox = document.getElementById(`level${level.charAt(0) + level.slice(1).toLowerCase().replace('_', '')}`);
            if (checkbox?.checked) allowedTibberLevels.push(level);
        });

        return {
            enabled: true, // Always enabled when saving

            // Tibber integration
            tibberApiKey,
            country: document.getElementById('country')?.value,
            city: document.getElementById('city')?.value,
            timezone: document.getElementById('timezone')?.value,

            // Price-based charging
            priceBasedCharging: {
                enabled: document.getElementById('enablePriceCharging')?.checked,
                useRealTibberPrices: true,
                useTibberLevels: document.getElementById('useTibberLevels')?.checked,
                allowedTibberLevels,
                maxPriceThreshold: parseFloat(document.getElementById('maxPriceThreshold')?.value || 0.20),
                preferTibberLevels: true
            },

            // Battery settings
            battery: {
                emergencySoC: parseInt(document.getElementById('emergencySOC')?.value || 15),
                minimumSoC: parseInt(document.getElementById('minimumSOC')?.value || 20),
                targetSoC: parseInt(document.getElementById('targetSOC')?.value || 80),
                maxSoC: parseInt(document.getElementById('maxSOC')?.value || 95)
            },

            // Weather conditions
            weatherConditions: {
                enabled: document.getElementById('enableWeatherConditions')?.checked,
                weatherApiKey,
                cloudCoverThreshold: parseInt(document.getElementById('cloudCoverThreshold')?.value || 70),
                chargeOnCloudyDays: document.getElementById('chargeOnCloudyDays')?.checked,
                chargeBeforeStorm: document.getElementById('chargeBeforeStorm')?.checked
            },

            // Time conditions
            timeConditions: {
                enabled: document.getElementById('enableTimeConditions')?.checked,
                avoidPeakHours: document.getElementById('avoidPeakHours')?.checked,
                preferNightCharging: document.getElementById('preferNightCharging')?.checked,
                peakStart: document.getElementById('peakStart')?.value || '17:00',
                peakEnd: document.getElementById('peakEnd')?.value || '21:00',
                nightStart: document.getElementById('nightStart')?.value || '22:00',
                nightEnd: document.getElementById('nightEnd')?.value || '06:00'
            },

            // Smart power conditions
            smartPowerConditions: {
                enabled: document.getElementById('enablePowerConditions')?.checked,
                rules: this.powerRules
            },

            // Scheduled charging
            scheduledCharging: document.getElementById('enableScheduledCharging')?.checked,
            chargingHours: this.schedules,

            // Cooldown settings
            cooldownSettings: {
                enabled: document.getElementById('enableCooldown')?.checked,
                chargingCooldownMinutes: parseInt(document.getElementById('chargingCooldownMinutes')?.value || 30),
                maxChargingCyclesPerDay: parseInt(document.getElementById('maxChargingCyclesPerDay')?.value || 8)
            }
        };
    }

    async toggleEnable(enabled) {
        try {
            const settings = { enabled };
            
            const response = await fetch('/api/dynamic-pricing/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });

            const data = await response.json();
            
            if (data.success) {
                const action = enabled ? 'enabled' : 'disabled';
                this.showToast(`Dynamic pricing ${action}`, enabled ? 'success' : 'warning');
                setTimeout(() => this.loadStatus(), 1000);
            } else {
                throw new Error(data.error || 'Failed to toggle dynamic pricing');
            }
        } catch (error) {
            console.error('‚ùå Error toggling dynamic pricing:', error);
            this.showToast('Failed to toggle: ' + error.message, 'error');
        }
    }

    async testTibberConnection() {
        const apiKeyField = document.getElementById('tibberApiKey');
        const testBtn = document.getElementById('testTibberBtn');
        
        if (!apiKeyField || !testBtn) return;

        let apiKey = apiKeyField.value;
        if (apiKey.includes('...')) {
            this.showToast('Please enter your full Tibber API key to test', 'warning');
            return;
        }

        const originalText = testBtn.textContent;
        testBtn.textContent = 'Testing...';
        testBtn.disabled = true;

        try {
            const response = await fetch('/api/dynamic-pricing/test-tibber', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ apiKey })
            });

            const data = await response.json();
            
            if (data.success) {
                this.showToast(`‚úÖ Tibber connection successful! Found ${data.homes} home(s)`, 'success');
                this.updateElement('tibberConnection', 'Test passed');
            } else {
                this.showToast(`‚ùå Tibber test failed: ${data.error}`, 'error');
                this.updateElement('tibberConnection', 'Test failed');
            }
        } catch (error) {
            console.error('‚ùå Error testing Tibber:', error);
            this.showToast('Tibber test failed: ' + error.message, 'error');
        } finally {
            testBtn.textContent = originalText;
            testBtn.disabled = false;
        }
    }

    async testWeatherConnection() {
        const apiKeyField = document.getElementById('weatherApiKey');
        const countryField = document.getElementById('country');
        const cityField = document.getElementById('city');
        const testBtn = document.getElementById('testWeatherBtn');
        
        if (!apiKeyField || !testBtn) return;

        let weatherApiKey = apiKeyField.value;
        if (weatherApiKey.includes('...')) {
            this.showToast('Please enter your full weather API key to test', 'warning');
            return;
        }

        const originalText = testBtn.textContent;
        testBtn.textContent = 'Testing...';
        testBtn.disabled = true;

        try {
            const response = await fetch('/api/dynamic-pricing/test-weather', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    weatherApiKey,
                    country: countryField?.value,
                    city: cityField?.value
                })
            });

            const data = await response.json();
            
            if (data.success) {
                this.showToast(`‚úÖ Weather API test successful!`, 'success');
                // Update weather display immediately
                this.updateWeatherDisplay();
            } else {
                this.showToast(`‚ùå Weather test failed: ${data.error}`, 'error');
            }
        } catch (error) {
            console.error('‚ùå Error testing weather:', error);
            this.showToast('Weather test failed: ' + error.message, 'error');
        } finally {
            testBtn.textContent = originalText;
            testBtn.disabled = false;
        }
    }

    toggleApiKeyVisibility() {
        const apiKeyField = document.getElementById('tibberApiKey');
        const toggleBtn = document.getElementById('toggleApiKey');
        
        if (!apiKeyField || !toggleBtn) return;

        const icon = toggleBtn.querySelector('i');
        
        if (apiKeyField.type === 'password') {
            apiKeyField.type = 'text';
            icon.classList.replace('fa-eye', 'fa-eye-slash');
        } else {
            apiKeyField.type = 'password';
            icon.classList.replace('fa-eye-slash', 'fa-eye');
        }
    }

    // Power Rules Management
    updatePowerRulesList() {
        const container = document.getElementById('powerRulesList');
        if (!container) return;

        container.innerHTML = '';

        this.powerRules.forEach((rule, index) => {
            const item = document.createElement('div');
            item.className = 'power-rule-item';
            
            item.innerHTML = `
                <div class="power-rule-info">
                    <h6>${rule.name}</h6>
                    <p>${rule.description || 'Custom power rule'}</p>
                    <div class="power-rule-priority ${rule.priority}">${rule.priority} Priority</div>
                </div>
                <div class="power-rule-actions">
                    <button class="btn btn-icon" onclick="dashboard.editPowerRule(${index})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-icon" onclick="dashboard.deletePowerRule(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(item);
        });

        if (this.powerRules.length === 0) {
            container.innerHTML = '<p>No custom power rules defined. Click "Add New Rule" to create one.</p>';
        }
    }

    openPowerRuleModal(editIndex = null) {
        const modal = document.getElementById('powerRuleModal');
        if (!modal) return;

        this.currentEditingRule = editIndex;
        
        if (editIndex !== null) {
            const rule = this.powerRules[editIndex];
            document.getElementById('ruleName').value = rule.name;
            document.getElementById('ruleDescription').value = rule.description || '';
            document.getElementById('rulePriority').value = rule.priority;
        } else {
            document.getElementById('ruleName').value = '';
            document.getElementById('ruleDescription').value = '';
            document.getElementById('rulePriority').value = 'medium';
        }

        modal.classList.add('active');
    }

    closePowerRuleModal() {
        const modal = document.getElementById('powerRuleModal');
        if (modal) {
            modal.classList.remove('active');
        }
        this.currentEditingRule = null;
    }

    editPowerRule(index) {
        this.openPowerRuleModal(index);
    }

    deletePowerRule(index) {
        if (confirm('Are you sure you want to delete this power rule?')) {
            this.powerRules.splice(index, 1);
            this.updatePowerRulesList();
        }
    }

    addCondition() {
        const container = document.getElementById('ruleConditions');
        if (!container) return;

        const conditionDiv = document.createElement('div');
        conditionDiv.className = 'condition-item';
        conditionDiv.innerHTML = `
            <div class="config-grid">
                <div class="config-item">
                    <label>Parameter</label>
                    <select class="config-input condition-parameter">
                        <option value="battery_soc">Battery SoC (%)</option>
                        <option value="pv_power">PV Power (W)</option>
                        <option value="load_power">Load Power (W)</option>
                        <option value="grid_power">Grid Power (W)</option>
                        <option value="battery_power">Battery Power (W)</option>
                    </select>
                </div>
                <div class="config-item">
                    <label>Operator</label>
                    <select class="config-input condition-operator">
                        <option value="gt">Greater than</option>
                        <option value="lt">Less than</option>
                        <option value="gte">Greater than or equal</option>
                        <option value="lte">Less than or equal</option>
                        <option value="eq">Equal to</option>
                    </select>
                </div>
                <div class="config-item">
                    <label>Value</label>
                    <input type="number" class="config-input condition-value" placeholder="Enter value">
                </div>
                <div class="config-item">
                    <button class="btn btn-outline" onclick="this.closest('.condition-item').remove()">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        
        container.appendChild(conditionDiv);
    }

    savePowerRule() {
        const name = document.getElementById('ruleName').value;
        const description = document.getElementById('ruleDescription').value;
        const priority = document.getElementById('rulePriority').value;

        if (!name.trim()) {
            this.showToast('Please enter a rule name', 'warning');
            return;
        }

        // Gather conditions
        const conditions = {};
        const conditionItems = document.querySelectorAll('.condition-item');
        
        conditionItems.forEach(item => {
            const parameter = item.querySelector('.condition-parameter').value;
            const operator = item.querySelector('.condition-operator').value;
            const value = parseFloat(item.querySelector('.condition-value').value);
            
            if (parameter && operator && !isNaN(value)) {
                conditions[parameter] = { operator, value };
            }
        });

        if (Object.keys(conditions).length === 0) {
            this.showToast('Please add at least one condition', 'warning');
            return;
        }

        const rule = {
            id: this.currentEditingRule !== null ? this.powerRules[this.currentEditingRule].id : Date.now(),
            name: name.trim(),
            description: description.trim(),
            priority,
            enabled: true,
            conditions
        };

        if (this.currentEditingRule !== null) {
            this.powerRules[this.currentEditingRule] = rule;
        } else {
            this.powerRules.push(rule);
        }

        this.updatePowerRulesList();
        this.closePowerRuleModal();
        this.showToast('Power rule saved', 'success');
    }

    // Schedule Management
    updateSchedulesList() {
        const container = document.getElementById('schedulesList');
        if (!container) return;

        container.innerHTML = '';

        this.schedules.forEach((schedule, index) => {
            const item = document.createElement('div');
            item.className = 'schedule-item';
            
            const days = schedule.days ? schedule.days.join(', ') : 'Daily';
            
            item.innerHTML = `
                <div class="schedule-time">${schedule.start} - ${schedule.end}</div>
                <div class="schedule-days">${days}</div>
                <button class="btn btn-outline" onclick="dashboard.deleteSchedule(${index})">
                    <i class="fas fa-trash"></i> Remove
                </button>
            `;
            
            container.appendChild(item);
        });

        if (this.schedules.length === 0) {
            container.innerHTML = '<p>No charging schedules defined.</p>';
        }
    }

    addSchedule() {
        const start = prompt('Enter start time (HH:MM):');
        const end = prompt('Enter end time (HH:MM):');
        
        if (start && end) {
            const timeRegex = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
            if (timeRegex.test(start) && timeRegex.test(end)) {
                this.schedules.push({ start, end });
                this.updateSchedulesList();
            } else {
                this.showToast('Invalid time format. Use HH:MM', 'error');
            }
        }
    }

    deleteSchedule(index) {
        if (confirm('Remove this charging schedule?')) {
            this.schedules.splice(index, 1);
            this.updateSchedulesList();
        }
    }

    // Utility Functions
    async resetSettings() {
        if (!confirm('Reset all settings to defaults? This cannot be undone.')) return;

        try {
            // You could implement a reset API endpoint, or just reload defaults
            location.reload();
        } catch (error) {
            this.showToast('Failed to reset settings', 'error');
        }
    }

    exportSettings() {
        const settings = this.gatherSettingsFromForm();
        const dataStr = JSON.stringify(settings, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = 'dynamic-pricing-settings.json';
        link.click();
    }

    importSettings() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const settings = JSON.parse(e.target.result);
                    this.populateSettingsFromImport(settings);
                    this.showToast('Settings imported successfully', 'success');
                } catch (error) {
                    this.showToast('Invalid settings file', 'error');
                }
            };
            reader.readAsText(file);
        };
        
        input.click();
    }

    populateSettingsFromImport(settings) {
        // Populate form with imported settings
        // This would be similar to populateSettingsForm but from imported data
        console.log('Importing settings:', settings);
        // Implementation would set form fields from settings object
    }

    showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer') || document.body;
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        const iconMap = {
            success: 'fas fa-check-circle',
            error: 'fas fa-exclamation-circle',
            warning: 'fas fa-exclamation-triangle',
            info: 'fas fa-info-circle'
        };
        
        toast.innerHTML = `
            <i class="${iconMap[type] || iconMap.info}"></i>
            <span>${message}</span>
        `;
        
        container.appendChild(toast);
        
        // Trigger animation
        setTimeout(() => toast.classList.add('show'), 100);
        
        // Remove after delay
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => container.removeChild(toast), 300);
        }, 5000);
    }

    destroy() {
        this.stopRealTimeUpdates();
        if (this.priceChart) {
            this.priceChart.destroy();
        }
        console.log('üîã Dynamic Pricing Dashboard destroyed');
    }
}

// Initialize dashboard when DOM is loaded
let dashboard;

document.addEventListener('DOMContentLoaded', () => {
    dashboard = new DynamicPricingDashboard();
});

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (dashboard) {
        dashboard.destroy();
    }
});
 </script>
</body>
</html>